<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cgtfs: API (brief) overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cgtfs
   &#160;<span id="projectnumber">0.5.0</span>
   </div>
   <div id="projectbrief">a C library to read static GTFS feeds</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">API (brief) overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>If you are looking for a very brief introduction, <a class="el" href="a00260.html">data transition guide</a> might be a better starting point. However, having gone through this file would prove highly benefitial when using the library.</p>
<h1><a class="anchor" id="ApiOverview__Introduction"></a>
Basics</h1>
<p>The library tries to provide a semantic, consistent and readable interface. The following diagrams show the ways GTFS data can be parsed or transferred between different storage types using this library.</p>
<p><em>Note: <b>bold arrows</b> indicate that such a function exists in the API which makes it possible to transfer the entire contents of a feed between two types of storage with a single function call (not counting the setup and teardown functions).</em></p>
<div style="text-align: center;"> <div style="display: inline-block; width: 100%; max-width: 500px; padding-right: 5%;"> <div class="image">
<object type="image/svg+xml" data="df_straight.svg" width="100%">df_straight.svg</object>
<div class="caption">
Ways to parse/tranport data with CGTFS (simple diagram)</div></div>
 </div> <div style="display: inline-block; width: 100%; max-width: 400px;"> <div class="image">
<object type="image/svg+xml" data="df_scheme.svg" width="100%">df_scheme.svg</object>
<div class="caption">
Ways to parse/tranport data with CGTFS (scheme)</div></div>
 </div> </div><h2><a class="anchor" id="ApiOverview__Introduction__Terms"></a>
Terms</h2>
<p>The terms used throughout the library code and documentation differ from those defined by the <a href="https://developers.google.com/transit/gtfs/reference/#term-definitions">GTFS reference</a>. The following table illustrates the relation between differing CGTFS terms and reference terms, and their definitions, as well as terms used in the library and abscent from the reference.</p>
<table class="doxtable">
<tr>
<th>CGTFS term </th><th>Reference term </th><th>Meaning and notes  </th></tr>
<tr>
<td>Feed (entity/instance/object) </td><td><em>not defined</em> </td><td>A data structure holding the entirety of a feed's data. <em>In the code and documentation, may be referred to as a feed entity, feed instance or feed object.</em> </td></tr>
<tr>
<td>Directory </td><td>Dataset </td><td>A set of files which constitutes a GTFS feed. In some contexts, in the code documentation, terms <em>feed</em> and <em>directory</em> are interchangable. <em>Note: GTFS datasets are distributed in form of <code>*.zip</code> feed archives. This library, however, only works with unpacked feeds.</em> </td></tr>
<tr>
<td>Entity (instance) </td><td>Record </td><td>A complete data structure containing information about a concrete GTFS entity (e.g. information about one route). The library uses the term <em>entity</em> to avoid ambiguity with database operations. <em>Note: however, <em>entity</em> is a more abstract term, thus a struct holding one entity's data is, in essense, an entity instance. This documentation may refer to structs simply as <b>entities</b> for shortness</em>. </td></tr>
<tr>
<td>File </td><td><em>not defined</em> </td><td>A <code>*.txt</code> file, a part of the feed, holding information about all the feed's <em>entities</em> of a single type. </td></tr>
<tr>
<td>Database </td><td>n/a </td><td>A single <em>SQLite</em> database file, created using the supplied SQL schema (preferably, the creation of the database is left to the library, see the database section). </td></tr>
</table>
<h1><a class="anchor" id="ApiOverview__Principles"></a>
Principles</h1>
<p>There are several core principles which could help in understanding the vast interface of the library. Some of them have been enforced from the beginning, others may be gradually integrated into the API.</p>
<ul>
<li>All structs and enumerations have names ending with <code>_t</code>.</li>
<li>All enumerations have members with names reflecting the enumeration's name.<ul>
<li>Entity field enumerations start with the first letters of the enumeration's name, e.g. <code>payment_method_t</code> has elements <code>PM_ON_BOARD</code>, <code>PM_BEFOREHAND</code> and <code>PM_NOT_SET</code>.<ul>
<li>There are exceptions at naming conflicts, e.g. <code>pathway_mode_t</code>, which would have to start its members' names with <code>PM</code> but uses <code>PTMD</code> instead.</li>
<li>Additionally, all entity field enumerations have <code>..._NOT_SET</code> members.</li>
</ul>
</li>
</ul>
</li>
<li>All structs have <code>init_...()</code> functions for initializing them. These functions MUST be called before the first use of the structure.<ul>
<li>Feed entity and record entity structs also have <code>read_...()</code> and <code>equal_...()</code> functions.</li>
<li>Structs which need deallocation after use have <code>free_...()</code> functions.</li>
</ul>
</li>
<li>All functions which have to do something with database operations have <code>_db</code> postfix.</li>
</ul>
<h1><a class="anchor" id="ApiOverview__Strings"></a>
String storage</h1>
<p>String values in CGTFS are stored in memory using statically allocated c-strings. Hence, parsing an unsually long string value may lead to a fatal crash. Default string field lengths are rather sensible but might by too big (bloating the RAM used significantly) or too small (causing crash).</p>
<p>To mitigate that, all string field length definitions are located in the <code><a class="el" href="a00149.html" title="Unified place for entity field c-string lengths definitions. ">xstrlengths.h</a></code> header. Actual field length definitions are heavily commented in the lower part of the file. By default, they are using <code>CGTFS_SL_BASE_</code> definitions found in the upper part of the file. There are three possible usage cases:</p>
<ol type="1">
<li>All left as it is in hopes for lucky circumstances.</li>
<li>Definition <code>CGTFS_SL_MODE_PREPARATION</code> is uncommented, reserving an obstinate amount of memory for all fields.</li>
<li>Maximum length of each field type is deduced from the supposed data sources (useful if you're working with the data form a specific agency). This is left to the developer.</li>
</ol>
<h1><a class="anchor" id="ApiOverview__Structure"></a>
Structure</h1>
<p>The library's API is divided into two so called layers, additional auxiliary functionality and loosely related helpers:</p>
<ul>
<li><a class="el" href="a00152.html">Core layer</a> provides basic definitions and functions for handling GTFS feeds and entities, and includes:<ul>
<li><a class="el" href="a00156.html">feed object definition</a> to store data of an entire feed and functions for working with it:<ul>
<li>a function to initialize a feed object;</li>
<li>a function to parse a feed object from a given directory path;</li>
<li>a function to determine whether two feed objects are equal;</li>
</ul>
</li>
<li>field enumerations to represent types and values of the fields which can only take values from a limited set defined by the specification, e.g. <a href="https://developers.google.com/transit/gtfs/reference/#routestxt"><code>routes.txt/route type</code></a>;<ul>
<li>functions to parse field enumeration values from a char array;</li>
</ul>
</li>
<li><a class="el" href="a00158.html">entity definitions</a> to represent e.g. an agency, a stop, a shape, etc. and <a class="el" href="a00160.html">functions</a> for handling them;<ul>
<li>functions to initialize entity instances;</li>
<li>functions to parse entity instances from a char array of field names and a char array of field values;</li>
<li>functions to determine whether two entity instances are equal;</li>
</ul>
</li>
<li><a class="el" href="a00161.html">batch entity parsing functions</a> which parse an array of entities from a given <code>*.txt</code> file path;</li>
</ul>
</li>
<li><a class="el" href="a00153.html">Database layer</a> provides definitions and functions for working with entities defined in the <em>core layer</em> with/through/in a SQLite database instance, and includes:<ul>
<li><a class="el" href="a00177.html#a00190">definition of a connection to a sqlite database</a> and <a class="el" href="a00178.html">functions</a> for working with it:<ul>
<li>a function to initialize a database connection;</li>
<li>a function to free/close a database connection;</li>
<li>a function to setup a database at an opened connection for a GTFS feed;</li>
</ul>
</li>
<li>storage transition functions:<ul>
<li>a <a class="el" href="a00178.html#gaef1e2ee826d375a2ed7dc4930e4b54e7">function</a> to <b>semantically</b> store the contents of a feed from a specified directory into a specified database connection (see note below);</li>
<li>a <a class="el" href="a00178.html#ga6ab599038ba2cf94a5458f1aeb2552ff">function</a> to <b>non-semantically</b> store the contents of a feed from a specified directory into a specified database connection (see note below);</li>
<li>a <a class="el" href="a00178.html#ga27aa50456dd81eef62ce8e56c145187c">function</a> to fetch the contents of a feed from a specified database connection into a specicfied feed object;</li>
</ul>
</li>
<li>an <a class="el" href="a00177.html#ga45782c8787f0d20ee77ef2cccefb87d5">enumeration</a> of general database operation results (success / failure / so-so);</li>
<li><a class="el" href="a00179.html">functions</a> to store entities using a specified database connection;</li>
<li>the so-called table operations:<ul>
<li><a class="el" href="a00182.html">batch entity storing functions</a> which parse an array of entities from a given <code>*.txt</code> file path into a database table (doing so directly, without keeping an intermediate array in the memory);</li>
<li><a class="el" href="a00181.html">batch entity fetching functions</a> which retrieve an array of entities of a single type from a specified database connection;</li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="a00154.html">Utilities</a> include:<ul>
<li><a class="el" href="a00183.html">functions</a> for reading CSV files;</li>
<li>an assisting <a class="el" href="a00184.html">function</a> for clearing a c-string array;</li>
<li>utilitary <a class="el" href="a00186.html">functions</a> for working a with sqlite database;</li>
</ul>
</li>
<li><a class="el" href="a00155.html">Helpers</a> include:<ul>
<li>several preprocessor definitions used across the library;</li>
<li>a <a class="el" href="a00185.html#ga248f541831d99050d227b73935fe455f">function</a> for extracting filename without extension from a given path;</li>
<li>a <a class="el" href="a00155.html#gae2bbdb842d112551febe520ce94152a4">function</a> for making a filepath from a directory and a file in it;</li>
<li>a <a class="el" href="a00155.html#gae324b27e0934fc7c9646721394e2f671">function</a> for converting degrees into radians;</li>
<li>a <a class="el" href="a00155.html#a00198">geolocation definition</a> which holds a latitude value and a longitude value;<ul>
<li>a <a class="el" href="a00155.html#gad13af620e788c2b1fcc6684fcbfd258e">function</a> for calculating a distance (in meters) between the two geolocation points.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><em>Note: CGTFS provides two ways of parsing a directory into a database, semantic and non-semantic. Semantic stores all values according to the specification, creating a reference-defined database layout and filling it with data of according types. Non-semantic directly translates GTFS *.txt files as CSVs into the database, creating a layout based on file headers and storing all data as text. See more in the related documentation page.</em></p>
<p><em>Another note: up to release <code>1.0.0</code>, the library's API is a subject to a change without backwards-compatibility concerns.</em></p>
<p>A more detailed documentation for each layer, definition and function can be found in the module documentation, linked throughout the list.</p>
<h1><a class="anchor" id="ApiOverview__Examples"></a>
Examples</h1>
<p>Some example source code is located in the <code>examples/</code> folder of the library's source code. Digging into the <code>tests/</code> folder might as well be useful.</p>
<h2><a class="anchor" id="ApiOverview__Examples__0"></a>
Reading a feed into memory</h2>
<p>Usage shown in this example is not recommended for parsing a real feed, as it <b>will</b> take <b>a lot of</b> memory for any substantially big amounts of data.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00122.html">feed.h</a>&quot;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Example 0: read all feed data into memory</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> some_function(<span class="keywordtype">void</span>) {</div><div class="line">    <span class="comment">// Feed initialization.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// As with all entity structs (records, feed,</span></div><div class="line">    <span class="comment">// db connection, etc.), init_T(T *) function must be called.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Every such struct has to be eventually freed by free_T(T *),</span></div><div class="line">    <span class="comment">// with the notable exception of all record entities</span></div><div class="line">    <span class="comment">// (a unified approach to struct handling is still WIP).</span></div><div class="line">    <a class="code" href="a00156.html#a00194">feed_t</a> amazing_feed;</div><div class="line">    <a class="code" href="a00156.html#ga9decb9ade6fdf69c1c54d33d0eba0225">init_feed</a>(&amp;amazing_feed);</div><div class="line"></div><div class="line">    <span class="comment">// Feed reading.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// This function is a convenience wrapper for calling</span></div><div class="line">    <span class="comment">// file-scope reading functions, which read the entire</span></div><div class="line">    <span class="comment">// *.txt files into arrays. This function passes pointers</span></div><div class="line">    <span class="comment">// to feed_t fields, and after reading stores the counts</span></div><div class="line">    <span class="comment">// of each parsed record type into _count fields.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Obviously, takes **a lot** of memory.</span></div><div class="line">    <a class="code" href="a00156.html#ga2994e392bb1b1c47a217865140f43d64">read_feed</a>(&amp;amazing_feed, <span class="stringliteral">&quot;../tests/data/google_sample&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">// If a *.txt file does not exist or cannot be opened,</span></div><div class="line">    <span class="comment">// -1 is assigned to the corresponding _count field.</span></div><div class="line">    <span class="comment">// If the file can be opened but has no records, 0 is assigned.</span></div><div class="line">    <span class="comment">// Otherwise, the field gets the number of records read from the file.</span></div><div class="line">    <span class="keywordflow">if</span> (amazing_feed.<a class="code" href="a00156.html#a6364353779db84f8f26549d78ab1e2e7">agency_count</a> &gt; 0)</div><div class="line">        printf(<span class="stringliteral">&quot;The agency&#39;s name is: %s \n&quot;</span>, amazing_feed.<a class="code" href="a00156.html#a66ec2e3ec7d861e13f8b9abb132d994f">agencies</a>[0].<a class="code" href="a00158.html#ae823f818388ef81372bba19aeb9fd070">name</a>);</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">        perror(<span class="stringliteral">&quot;Failed to open agency.txt or the file has no records&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Don&#39;t forget to call this function.</span></div><div class="line">    <span class="comment">// No, really :|</span></div><div class="line">    <a class="code" href="a00122.html#ad506bf45c542373ff523f80dd7ab8491">free_feed</a>(&amp;amazing_feed);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">    some_function();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="ApiOverview__Examples__1"></a>
An entity file reading</h2>
<p>Read all bus stops and print out their information</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00128.html">helpers/filenames.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00140.html">reading.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> do_stuff_with_stop(<a class="code" href="a00158.html#a00246">stop_t</a> *stop);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Example 1: read all bus stops into memory</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> another_function(<span class="keywordtype">void</span>) {</div><div class="line">    <span class="keywordtype">int</span> stops_count = 0;</div><div class="line">    <a class="code" href="a00158.html#a00246">stop_t</a> *stops;</div><div class="line"></div><div class="line">    <span class="comment">// It&#39;s 100% up to the developer to ensure</span></div><div class="line">    <span class="comment">// that the correct file is passed</span></div><div class="line">    <span class="comment">// to the parsing functions.</span></div><div class="line">    FILE *fp = fopen(<span class="stringliteral">&quot;../tests/data/google_sample/stops.txt&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">    <span class="keywordflow">if</span> (fp) {</div><div class="line">        <span class="comment">// The function allocates all the required memory.</span></div><div class="line">        stops_count = <a class="code" href="a00161.html#ga837f7f0ef7f0fcd5f300e1dc8e3f4c34">read_all_stops</a>(fp, &amp;stops);</div><div class="line">        fclose(fp);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; stops_count; i++)</div><div class="line">        do_stuff_with_stop(&amp;(stops[i]));</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (stops_count &gt; 0)</div><div class="line">        free(stops);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> do_stuff_with_stop(<a class="code" href="a00158.html#a00246">stop_t</a> *stop) {</div><div class="line">        printf(<span class="stringliteral">&quot;&lt;stop %s&gt;\n&quot;</span>, stop-&gt;<a class="code" href="a00158.html#a34dfc7ccbfa4c5bff249ce139d59830c">id</a>);</div><div class="line">        printf(<span class="stringliteral">&quot;  Name:       %s\n&quot;</span>, stop-&gt;<a class="code" href="a00158.html#a399ad9b305dfa103c0f1ecac87b07660">name</a>);</div><div class="line">        printf(<span class="stringliteral">&quot;  Latitude:   %Lf\n&quot;</span>, stop-&gt;<a class="code" href="a00158.html#a8fd6a37ceeee02381ac46587b6feba05">lat</a>);</div><div class="line">        printf(<span class="stringliteral">&quot;  Longitude:  %Lf\n\n&quot;</span>, stop-&gt;<a class="code" href="a00158.html#afa18fdcc6ad66ae0c1ea7807e7f29754">lon</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">    another_function();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="ApiOverview__Examples__2"></a>
Database-backed querying</h2>
<p>Store a gtfs folder as a database and query it for first 10 stop time records with arrival time within the next 10 minutes.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00122.html">feed.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00059.html">database/database.h</a>&quot;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> row_callback(<span class="keywordtype">void</span> *, <span class="keywordtype">int</span> column_count, <span class="keywordtype">char</span> **data, <span class="keywordtype">char</span> **column_names);</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Example 2:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Store gtfs folder as a database and</span></div><div class="line"><span class="comment"> * query it for first 10 stop_time records</span></div><div class="line"><span class="comment"> * with arrival time within the next 10 minutes.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="comment">// The querying itself is done via SQL.</span></div><div class="line"><span class="comment">// CGTFS only handles creating the database,</span></div><div class="line"><span class="comment">// setting up the layout and filling it with</span></div><div class="line"><span class="comment">// feeds&#39; data.</span></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *sql_query =</div><div class="line">    <span class="stringliteral">&quot;SELECT stop_id, trip_id, arrival_time &quot;</span></div><div class="line">    <span class="stringliteral">&quot;FROM stop_times &quot;</span></div><div class="line">    <span class="stringliteral">&quot;WHERE arrival_time &quot;</span></div><div class="line">        <span class="stringliteral">&quot;BETWEEN time(&#39;now&#39;, &#39;localtime&#39;) &quot;</span></div><div class="line">        <span class="stringliteral">&quot;AND time(&#39;now&#39;, &#39;+10 minutes&#39;, &#39;localtime&#39;) &quot;</span></div><div class="line">    <span class="stringliteral">&quot;LIMIT 10;&quot;</span>;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> some_database_manipulation(<span class="keywordtype">void</span>) {</div><div class="line">    <span class="keywordtype">char</span> *error_msg = NULL;</div><div class="line"></div><div class="line">    <a class="code" href="a00177.html#a00190">feed_db_t</a> database;</div><div class="line">    <a class="code" href="a00177.html#ga45782c8787f0d20ee77ef2cccefb87d5">feed_db_status_t</a> result;</div><div class="line"></div><div class="line">    <span class="comment">// Database connection initialization.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// This function sets up default values</span></div><div class="line">    <span class="comment">// for the connection struct</span></div><div class="line">    <span class="comment">// and opens the connection.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Calling free_feed_db(..) is recommended as soon</span></div><div class="line">    <span class="comment">// as the connection is no longer needed.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Opening the connection again is preferred to</span></div><div class="line">    <span class="comment">// keeping stuff open and, thus, locked.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// The sign in `result &lt; FEED_DB_SUCCESS` allows</span></div><div class="line">    <span class="comment">// the result of operation to be FEED_DB_PARTIAL (see docs),</span></div><div class="line">    <span class="comment">// though for now, it only really matters with store_feed_db(..) .</span></div><div class="line">    result = <a class="code" href="a00178.html#ga13d4d9a2e28efa18ea54f551121239c2">init_feed_db</a>(&amp;database, <span class="stringliteral">&quot;example2.db&quot;</span>, 1);</div><div class="line">    <span class="keywordflow">if</span> (result &lt; <a class="code" href="a00177.html#gga45782c8787f0d20ee77ef2cccefb87d5af14bbd458e276ae6173f2327ef8a8406">FEED_DB_SUCCESS</a>) {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to create/open a test database: %s !\n&quot;</span>, database.<a class="code" href="a00177.html#aff3d69d17c4ad1a88762c7370178e92a">error_msg</a>);</div><div class="line">        <span class="keywordflow">goto</span> clearup;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Database layout setup.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// This function is, basically, a wrapper around a giant SQL query.</span></div><div class="line">    <span class="comment">// Ideally, it is done every once in a set time interval (day, probably),</span></div><div class="line">    <span class="comment">// as there is no need to do it every time some information is needed.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Every time the database is updated,</span></div><div class="line">    <span class="comment">// it must be deleted (left to the developer).</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// This function is most likely to be followed by store_feed_db(..) .</span></div><div class="line">    result = <a class="code" href="a00178.html#ga9d1d232b0e8f28ac0b87b9742a980996">setup_feed_db</a>(&amp;database);</div><div class="line">    <span class="keywordflow">if</span> (result &lt; <a class="code" href="a00177.html#gga45782c8787f0d20ee77ef2cccefb87d5af14bbd458e276ae6173f2327ef8a8406">FEED_DB_SUCCESS</a>) {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to create the layout of the test database: %s !\n&quot;</span>, database.<a class="code" href="a00177.html#aff3d69d17c4ad1a88762c7370178e92a">error_msg</a>);</div><div class="line">        <span class="keywordflow">goto</span> clearup;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Feed storing.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// This function reads every feed file</span></div><div class="line">    <span class="comment">// and reads its records directly into the database,</span></div><div class="line">    <span class="comment">// without an intermediate array.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Unless CGTFS_STORING_BATCH_TRANSACTIONS_OFF is defined, each</span></div><div class="line">    <span class="comment">// file&#39;s contents are stored in a single transaction.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Both FEED_DB_SUCCESS and FEED_DB_PARTIAL are acceptable results.</span></div><div class="line">    <span class="comment">// Use equality sign only if your feed has records in EVERY possible</span></div><div class="line">    <span class="comment">// feed file.</span></div><div class="line">    result = <a class="code" href="a00178.html#ga6ab599038ba2cf94a5458f1aeb2552ff">store_feed_db</a>(<span class="stringliteral">&quot;../tests/data/pocono_pony&quot;</span>, &amp;database, NULL);</div><div class="line">    <span class="keywordflow">if</span> (result &lt; <a class="code" href="a00177.html#gga45782c8787f0d20ee77ef2cccefb87d5af14bbd458e276ae6173f2327ef8a8406">FEED_DB_SUCCESS</a>) {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to store a test gtfs directory: data/pocono_pony: %s !\n&quot;</span>, database.<a class="code" href="a00177.html#aff3d69d17c4ad1a88762c7370178e92a">error_msg</a>);</div><div class="line">        <span class="keywordflow">goto</span> clearup;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// The querying itself.</span></div><div class="line">    database.<a class="code" href="a00177.html#aad0139c08f6e31a66e145a019b1e0437">rc</a> = sqlite3_exec(database.<a class="code" href="a00177.html#af18818af8f19ecda563bad15478074de">conn</a>, sql_query, row_callback, NULL, &amp;error_msg);</div><div class="line">    <span class="keywordflow">if</span> (error_msg != NULL) {</div><div class="line">        printf(<span class="stringliteral">&quot;Error while executing query: %s !\n&quot;</span>, error_msg);</div><div class="line">        <span class="keywordflow">goto</span> clearup;</div><div class="line">    }</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Success.\n&quot;</span>);</div><div class="line"></div><div class="line">    clearup:</div><div class="line">    sqlite3_free(error_msg);</div><div class="line">    <a class="code" href="a00178.html#ga038548ff3d3967beaa634cc65a107f3e">free_feed_db</a>(&amp;database);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> row_callback(<span class="keywordtype">void</span> *param, <span class="keywordtype">int</span> column_count, <span class="keywordtype">char</span> **data, <span class="keywordtype">char</span> **column_names) {</div><div class="line">    <span class="keywordflow">if</span> (column_count &lt; 3)</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;&lt;stop %s&gt;\n&quot;</span>, data[0]);</div><div class="line">    printf(<span class="stringliteral">&quot;  Arrival time:  %s\n&quot;</span>, data[2]);</div><div class="line">    printf(<span class="stringliteral">&quot;  Trip id:       %s\n&quot;</span>, data[1]);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">    some_database_manipulation();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
<address class="footer">
  <small class="desc">
    cgtfs 0.5.0 &mdash; documentation generated by <span title="on Thu Aug 15 2019 16:23:34">Doxygen 1.8.13</span>
  </small>
  <small class="links">
    <a target="_blank" href="https://rakhack.github.io/cgtfs/" title="A pretty empty website \_(*^*)_/">Website</a>&mdash;
    <a target="_blank" href="https://github.com/rakhack/cgtfs" title="Main development platform & source code repository">GitHub</a>&mdash;
    <a target="_blank" href="https://raw.githubusercontent.com/rakhack/cgtfs/master/LICENSE" title="Library code">MIT License</a>&mdash;
    <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/" title="Documentation and related materials">CC BY 4.0</a>
  </small>
</address>
</body>
</html>
