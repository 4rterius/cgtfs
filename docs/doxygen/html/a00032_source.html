<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cgtfs: docs/doxygen/static/data_transition.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cgtfs
   &#160;<span id="projectnumber">0.5.0</span>
   </div>
   <div id="projectbrief">a C library to read static GTFS feeds</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">docs/doxygen/static/data_transition.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="a00032.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# Data transition guide {#data_transition}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;Although the entire library&#39;s public interface is exposed and considered to be of use for the developer using this library, the main expected use cases are parsing GTFS feeds and converting them into databases. This page provides commentary on how these actions could be done by the library&#39;s user.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;## Basic data structures</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;There are two core data structures which are designed to be used for operating on GTFS datasets: feed_t and feed_db_t.</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;### Feed entity</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;Feed entity, presented by the feed_t structure, stores data about all possible GTFS records, as specified by the format reference. Thus, it has fields storing the numbers of entities (e.g. feed_t.stops_count) and fields storing the entities themselves (e.g. feed_t.stops). The _count fields have `int` types, and entity fields are arrays of values with entities&#39; types (e.g. `agency_t *`). Feed entity must be:</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;  - initialized by calling init_feed() function before any use,</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;  - cleared by free_feed() immediately after it has been used.</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;As the library uses static buffers for storing record string fields, the feed entity takes *a lot* of memory. The exact relation between feed source size and memory taken by a feed_t instance varies, but be prepared for it to take at least an order of magnitude more memory. Thus, freeing the entity&#39;s memory is important and should be done ASAP. (The only exception to this is when the entity is used for storing counts only, as done by the third argument of store_feed_db().)</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;The following example is a common layout of the feed entity usage.</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;```c</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;#include &quot;feed.h&quot;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;void some_func(void) {</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    feed_t my_feed;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    init_feed(&amp;my_feed);</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    // Something done with my_feed.</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    free_feed(&amp;my_feed);</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;}</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;```</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;Also, see the following functions:</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  - read_feed() - explained below,</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  - equal_feeds().</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;### Feed database connection entity</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;Feed database connection entity (feed_db_t struct) stores data about a connection to a SQLite database. Namely, it stores path to the database file, a `sqlite3 *` value, an error message set by the library, a return code integer also set by the library, a boolean indicating whether the connection is open and a transaction state boolean, set by CGTFS&#39;s transaction functions. This allows the programmer to pass around the entire information about a SQLite connection in a simple and organized manner.</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;Encapsulating the connection data, it should be used with CGTFS, and is actually passed to all the library&#39;s database-related functions. This entity must be:</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  - initialized with init_feed_db() before usage (among other things, opens the connection),</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  - torn down with free_feed_db() after usage (frees the memory AND closes the connection).</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;The connection remains open until free_feed_db() is called on a struct, thus it is better to tear down the struct when you expect a large break in database operations during your program&#39;s execution.</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;As with most database operations, these two functions return a feed_db_status_t value.</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;The following example is a common layout of the feed database connection entity usage.</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;```c</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;#include &quot;feed.h&quot;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;#include &quot;database/database.h&quot;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;#define IS_WRITABLE = 1</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;int some_db_func(void) {</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    feed_db_t my_db;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    feed_db_status_t res;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    res = init_feed_db(&amp;my_db, &quot;/path/to/database/file&quot;, IS_WRITABLE);</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    if (res &lt; FEED_DB_SUCCESS) {</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        free_feed_db(&amp;my_db);</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        return 0;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    }</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    // Something done with my_db connection.</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    free_feed_db(&amp;my_db);  // this can also return an error, but it will be easier to just quit the program.</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    return 1;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;}</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;```</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;Also, see the following functions:</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  - setup_feed_db() - creates a database layout based on the GTFS reference,</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  - import_feed_db(), store_feed_db(), fetch_feed_db() - explained below,</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  - begin_transaction_db(), end_transaction_db() - begin and end SQLite transactions, writing the transaction state into the connection entity.</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;## Transition methods</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;### Reading to memory</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;The most primitive and the fastest parsing method stores a GTFS feed in the application memory. The amount of memory needed is much bigger than the size of the feed itself, due to static string field memory allocation.</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;Reading is done with the read_feed() function, taking a pointer to the database entity instance (see above) and a path to the directory with an unpacked GTFS feed. Always returns zero.</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;An example below shows the most primitive use case.</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;@include example_0.c</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;### Non-semantic import to database</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;Potentially the most used feature of the library. Reads all `*.txt` files in the given directory and parses their contents as if they were CSV files (which they are, actually). Is reasonably fast for a CSV parser. Realized in two functions.</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  - import_csv_file_db() which parses a CSV file at the given path into the given table in the given database. Creates the tables.</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  - import_feed_db() which is, basically, a convenience wrapper for the previous function, calling it for every file it finds in the given directory path. Table names are deduced from the filenames (stripping the `.txt` part).</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;```c</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;#include &quot;feed.h&quot;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;#include &quot;database/database.h&quot;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;#define IS_WRITABLE = 1</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;int some_db_func(void) {</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    feed_db_t my_db;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    feed_db_status_t res;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    res = init_feed_db(&amp;my_db, &quot;/path/to/database/file&quot;, IS_WRITABLE);</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    if (res &lt; FEED_DB_SUCCESS) {</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        puts(my_db.error_msg);</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        free_feed_db(&amp;my_db);</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        return 0;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    }</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    res = import_feed_db(&quot;/path/to/unpacked/gtfs/feed&quot;, &amp;my_db);</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    if (res &lt; FEED_DB_SUCCESS) {</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        puts(my_db.error_msg);</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        free_feed_db(&amp;my_db);</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        return 0;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    }</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    // Something done with the data in the database pointed to by my_db connection.</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    free_feed_db(&amp;my_db);</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    return 1;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;}</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;```</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;Also, see the following functions:</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  - get_filename_no_ext() - strips all but the base filename from a given path,</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  - make_filepath() - combines a given directory with a given filename.</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;### Semantic parsing to database</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;Another option for parsing a GTFS directory into a database. Unlike the prevous one, actually parses every @ref Core__EntityList &quot;record&quot; it finds. Hence, it is much (4+ times) slower than non-semantic parsing. As it parses data into reference-defined structs before storing them in the database, all non-standard files and fields are ignored; all files and fields which are not present leave empty tables or columns, respectively.</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;Done by store_feed_db() function, which takes the same arguments as import_feed_db(), and an optional `feed_t *feed_counter` argument, which, if not `NULL`, stores the numbers of parsed records once the function has returned a successful `feed_db_status_t` value. Unlike its non-semantic counterpart, the function requires a call to setup_feed_db() before usage to create the target database layout.</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;```c</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;#include &quot;feed.h&quot;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;#include &quot;database/database.h&quot;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;#define IS_WRITABLE = 1</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;int some_db_func(void) {</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    feed_db_t my_db;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    feed_db_status_t res;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    res = init_feed_db(&amp;my_db, &quot;/path/to/database/file&quot;, IS_WRITABLE);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    if (res &lt; FEED_DB_SUCCESS) {</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        free_feed_db(&amp;my_db);</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        return 0;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    }</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    res = setup_feed_db(&amp;my_db);</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    if (res &lt; FEED_DB_SUCCESS) {</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        puts(my_db.error_msg);</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        free_feed_db(&amp;my_db);</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        return 0;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    }</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    res = store_feed_db(&quot;/path/to/unpacked/gtfs/feed&quot;, &amp;my_db, NULL);</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    if (res &lt; FEED_DB_SUCCESS) {</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        puts(my_db.error_msg);</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        free_feed_db(&amp;my_db);</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        return 0;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    }</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    // Something done with the data in the database pointed to by my_db connection.</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    free_feed_db(&amp;my_db);</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    return 1;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;}</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;```</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;Also, if you have come as far as you did, see:</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  - the entire database feed entity @ref Database__FeedEntity &quot;documentation module&quot;.</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;### Fetching from database into memory</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;The function fetch_feed_db() provides a way to get *all* database records stored by CGTFS back to memory. Since the library does not provide GTFS file writing functionality, it can be seen as a counterpart for store_feed_db() function. Takes a database connection entity pointer and a feed entity pointer, and gets data from the former into the latter. Does not return anything, the success of the operation can be found by checking the resulting number of records in the feed entity pointed to by the value passed as the function&#39;s first argument.</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;```c</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;#include &quot;feed.h&quot;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;#include &quot;database/database.h&quot;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;#define IS_WRITABLE = 0</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;int some_db_func(void) {</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    feed_t my_feed;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    feed_db_t my_db;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    feed_db_status_t res;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    res = init_feed_db(&amp;my_db, &quot;/path/to/database/file&quot;, IS_WRITABLE);</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    if (res &lt; FEED_DB_SUCCESS) {</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        free_feed_db(&amp;my_db);</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        return 0;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    }</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    init_feed(&amp;my_feed);</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    res = fetch_feed_db(&amp;my_db, &amp;my_feed);</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    if (res &lt; FEED_DB_SUCCESS) {</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        puts(my_db.error_msg);</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        free_feed_db(&amp;my_db);</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        return 0;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    }</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    free_feed_db(&amp;my_db);</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    // Something done with the data in my_feed.</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    free_feed(&amp;my_feed);</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    return 1;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;}</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;```</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;## Performance</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;Generally, reading feeds to memory is the fastest operation of all discussed on this page, but it is also the most RAM-consuming. Non-semantic database import is the second fastest operation, taking 2-3 times longer than to-memory reading, but it is somewhat sensible in terms of RAM consumption. Semantic feed parsing into the database is the longest of the three, taking clearly inadequate time. Unless your target machine is *blazingly* fast, or you need a reference-compliant database with correct typing, you are advised against using this.</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;The following listing provides output from the CGTFS `./bench` executable, ran on several GTFS feeds on a Win10 i7-8550U NVMe machine through WSL 1.</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;```</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;# Pocono Pony (1.65 mb)</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;Benchmark results for / feed dir -&gt; memory parsing:</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160; -&gt; 1        iteration:    235690500 ns. / 1 iter. =&gt; 235.690500 ms.</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; -&gt; 10       iterations:   1522158000 ns. / 10 iter. =&gt; 152.215800 ms.</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;---------</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;Benchmark results for / feed dir -&gt; db parsing (semantic):</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160; -&gt; 1        iteration:    3559970000 ns. / 1 iter. =&gt; 3559.970000 ms.</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160; -&gt; 10       iterations:   33531279900 ns. / 10 iter. =&gt; 3353.127990 ms.</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;---------</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;Benchmark results for / feed dir -&gt; db parsing (non-semantic):</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160; -&gt; 1        iteration:    468014300 ns. / 1 iter. =&gt; 468.014300 ms.</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160; -&gt; 10       iterations:   5315382000 ns. / 10 iter. =&gt; 531.538200 ms.</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;---------</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;# LSL (20.6 mb)</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;Benchmark results for / feed dir -&gt; memory parsing:</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160; -&gt; 1        iteration:    2053141000 ns. / 1 iter. =&gt; 2053.141000 ms.</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160; -&gt; 10       iterations:   19250407600 ns. / 10 iter. =&gt; 1925.040760 ms.</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;---------</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;Benchmark results for / feed dir -&gt; db parsing (semantic):</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160; -&gt; 1        iteration:    14864547700 ns. / 1 iter. =&gt; 14864.547700 ms.</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160; -&gt; 10       iterations:   151779149800 ns. / 10 iter. =&gt; 15177.914980 ms.</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;---------</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;Benchmark results for / feed dir -&gt; db parsing (non-semantic):</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160; -&gt; 1        iteration:    3478527500 ns. / 1 iter. =&gt; 3478.527500 ms.</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160; -&gt; 10       iterations:   34999966400 ns. / 10 iter. =&gt; 3499.996640 ms.</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;---------</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;# MTA NYC Transit Subway (63.4 mb)</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;Benchmark results for / feed dir -&gt; memory parsing:</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160; -&gt; 1        iteration:    5560275600 ns. / 1 iter. =&gt; 5560.275600 ms.</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160; -&gt; 10       iterations:   53092411900 ns. / 10 iter. =&gt; 5309.241190 ms.</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;---------</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;Benchmark results for / feed dir -&gt; db parsing (semantic):</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160; -&gt; 1        iteration:    40642734000 ns. / 1 iter. =&gt; 40642.734000 ms.</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160; -&gt; 10       iterations:   376395287900 ns. / 10 iter. =&gt; 37639.528790 ms.</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;---------</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;Benchmark results for / feed dir -&gt; db parsing (non-semantic):</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160; -&gt; 1        iteration:    9276035200 ns. / 1 iter. =&gt; 9276.035200 ms.</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160; -&gt; 10       iterations:   91401069000 ns. / 10 iter. =&gt; 9140.106900 ms.</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;---------</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;```</div></div><!-- fragment --></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
<address class="footer">
  <small class="desc">
    cgtfs 0.5.0 &mdash; documentation generated by <span title="on Thu Aug 15 2019 16:23:34">Doxygen 1.8.13</span>
  </small>
  <small class="links">
    <a target="_blank" href="https://rakhack.github.io/cgtfs/" title="A pretty empty website \_(*^*)_/">Website</a>&mdash;
    <a target="_blank" href="https://github.com/rakhack/cgtfs" title="Main development platform & source code repository">GitHub</a>&mdash;
    <a target="_blank" href="https://raw.githubusercontent.com/rakhack/cgtfs/master/LICENSE" title="Library code">MIT License</a>&mdash;
    <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/" title="Documentation and related materials">CC BY 4.0</a>
  </small>
</address>
</body>
</html>
