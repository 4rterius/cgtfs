<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cgtfs: Data transition guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cgtfs
   &#160;<span id="projectnumber">0.5.0</span>
   </div>
   <div id="projectbrief">a C library to read static GTFS feeds</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Data transition guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Although the entire library's public interface is exposed and considered to be of use for the developer using this library, the main expected use cases are parsing GTFS feeds and converting them into databases. This page provides commentary on how these actions could be done by the library's user.</p>
<h2>Basic data structures</h2>
<p>There are two core data structures which are designed to be used for operating on GTFS datasets: <a class="el" href="a00156.html#a00194" title="A GTFS feed entity that encapsulates all data of a single GTFS feed. ">feed_t</a> and <a class="el" href="a00177.html#a00190" title="Base struct of all db processes to encapsulate the DB realization. ">feed_db_t</a>.</p>
<h3>Feed entity</h3>
<p>Feed entity, presented by the <a class="el" href="a00156.html#a00194" title="A GTFS feed entity that encapsulates all data of a single GTFS feed. ">feed_t</a> structure, stores data about all possible GTFS records, as specified by the format reference. Thus, it has fields storing the numbers of entities (e.g. <a class="el" href="a00156.html#a6efc302db7f81a1b955d94c62db37d61">feed_t.stops_count</a>) and fields storing the entities themselves (e.g. <a class="el" href="a00156.html#abeedefed4658912f6423375d88800d83">feed_t.stops</a>). The _count fields have <code>int</code> types, and entity fields are arrays of values with entities' types (e.g. <code><a class="el" href="a00158.html#a00202" title="agency.txt record ">agency_t</a> *</code>). Feed entity must be:</p>
<ul>
<li>initialized by calling <a class="el" href="a00156.html#ga9decb9ade6fdf69c1c54d33d0eba0225" title="Initializes a feed structure with default values (pointers/arrays with NULLs, *_count fields with 0-s...">init_feed()</a> function before any use,</li>
<li>cleared by <a class="el" href="a00122.html#ad506bf45c542373ff523f80dd7ab8491" title="Frees the memory taken by the given feed structure. ">free_feed()</a> immediately after it has been used.</li>
</ul>
<p>As the library uses static buffers for storing record string fields, the feed entity takes <em>a lot</em> of memory. The exact relation between feed source size and memory taken by a <a class="el" href="a00156.html#a00194" title="A GTFS feed entity that encapsulates all data of a single GTFS feed. ">feed_t</a> instance varies, but be prepared for it to take at least an order of magnitude more memory. Thus, freeing the entity's memory is important and should be done ASAP. (The only exception to this is when the entity is used for storing counts only, as done by the third argument of <a class="el" href="a00178.html#ga6ab599038ba2cf94a5458f1aeb2552ff" title="Reads an unpacked GTFS feed from the given directory to the given database. ">store_feed_db()</a>.)</p>
<p>The following example is a common layout of the feed entity usage.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00122.html">feed.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> some_func(<span class="keywordtype">void</span>) {</div><div class="line">    <a class="code" href="a00156.html#a00194">feed_t</a> my_feed;</div><div class="line">    <a class="code" href="a00156.html#ga9decb9ade6fdf69c1c54d33d0eba0225">init_feed</a>(&amp;my_feed);</div><div class="line"></div><div class="line">    <span class="comment">// Something done with my_feed.</span></div><div class="line"></div><div class="line">    <a class="code" href="a00122.html#ad506bf45c542373ff523f80dd7ab8491">free_feed</a>(&amp;my_feed);</div><div class="line">}</div></div><!-- fragment --><p>Also, see the following functions:</p>
<ul>
<li><a class="el" href="a00156.html#ga2994e392bb1b1c47a217865140f43d64" title="Reads an unpacked GTFS feed from the given folder into the given feed instance. ">read_feed()</a> - explained below,</li>
<li><a class="el" href="a00156.html#gaded6f815865c66ff2b8d1d9fee060b30" title="Compares two feed instances. ">equal_feeds()</a>.</li>
</ul>
<h3>Feed database connection entity</h3>
<p>Feed database connection entity (<a class="el" href="a00177.html#a00190" title="Base struct of all db processes to encapsulate the DB realization. ">feed_db_t</a> struct) stores data about a connection to a SQLite database. Namely, it stores path to the database file, a <code>sqlite3 *</code> value, an error message set by the library, a return code integer also set by the library, a boolean indicating whether the connection is open and a transaction state boolean, set by CGTFS's transaction functions. This allows the programmer to pass around the entire information about a SQLite connection in a simple and organized manner.</p>
<p>Encapsulating the connection data, it should be used with CGTFS, and is actually passed to all the library's database-related functions. This entity must be:</p>
<ul>
<li>initialized with <a class="el" href="a00178.html#ga13d4d9a2e28efa18ea54f551121239c2" title="Initializes a given feed database. ">init_feed_db()</a> before usage (among other things, opens the connection),</li>
<li>torn down with <a class="el" href="a00178.html#ga038548ff3d3967beaa634cc65a107f3e" title="Frees the memory taken by a feed database instance and closes the connection. ">free_feed_db()</a> after usage (frees the memory AND closes the connection).</li>
</ul>
<p>The connection remains open until <a class="el" href="a00178.html#ga038548ff3d3967beaa634cc65a107f3e" title="Frees the memory taken by a feed database instance and closes the connection. ">free_feed_db()</a> is called on a struct, thus it is better to tear down the struct when you expect a large break in database operations during your program's execution.</p>
<p>As with most database operations, these two functions return a feed_db_status_t value.</p>
<p>The following example is a common layout of the feed database connection entity usage.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00122.html">feed.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="a00059.html">database/database.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define IS_WRITABLE = 1</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> some_db_func(<span class="keywordtype">void</span>) {</div><div class="line">    <a class="code" href="a00177.html#a00190">feed_db_t</a> my_db;</div><div class="line">    <a class="code" href="a00177.html#ga45782c8787f0d20ee77ef2cccefb87d5">feed_db_status_t</a> res;</div><div class="line"></div><div class="line">    res = <a class="code" href="a00178.html#ga13d4d9a2e28efa18ea54f551121239c2">init_feed_db</a>(&amp;my_db, <span class="stringliteral">&quot;/path/to/database/file&quot;</span>, IS_WRITABLE);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (res &lt; <a class="code" href="a00177.html#gga45782c8787f0d20ee77ef2cccefb87d5af14bbd458e276ae6173f2327ef8a8406">FEED_DB_SUCCESS</a>) {</div><div class="line">        <a class="code" href="a00178.html#ga038548ff3d3967beaa634cc65a107f3e">free_feed_db</a>(&amp;my_db);</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Something done with my_db connection.</span></div><div class="line"></div><div class="line">    <a class="code" href="a00178.html#ga038548ff3d3967beaa634cc65a107f3e">free_feed_db</a>(&amp;my_db);  <span class="comment">// this can also return an error, but it will be easier to just quit the program.</span></div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div></div><!-- fragment --><p>Also, see the following functions:</p>
<ul>
<li><a class="el" href="a00178.html#ga9d1d232b0e8f28ac0b87b9742a980996" title="Creates the layout in the given database. ">setup_feed_db()</a> - creates a database layout based on the GTFS reference,</li>
<li><a class="el" href="a00178.html#gaef1e2ee826d375a2ed7dc4930e4b54e7" title="Imports an unpacked GTFS feed from the given directory to the given database non-semantically. ">import_feed_db()</a>, <a class="el" href="a00178.html#ga6ab599038ba2cf94a5458f1aeb2552ff" title="Reads an unpacked GTFS feed from the given directory to the given database. ">store_feed_db()</a>, <a class="el" href="a00178.html#ga27aa50456dd81eef62ce8e56c145187c" title="Reads a GTFS database to a feed instance. ">fetch_feed_db()</a> - explained below,</li>
<li><a class="el" href="a00186.html#ga2f7a4dc769dd959880463c66bb582eea" title="Starts a sqlite3 transaction. ">begin_transaction_db()</a>, <a class="el" href="a00186.html#gaeae8f35ab077206bc8082dda03f4816e" title="Ends a sqlite3 transaction. ">end_transaction_db()</a> - begin and end SQLite transactions, writing the transaction state into the connection entity.</li>
</ul>
<h2>Transition methods</h2>
<h3>Reading to memory</h3>
<h3>Non-semantic import to database</h3>
<h3>Semantic parsing to database</h3>
<h3>Fetching from database into memory</h3>
<h2>Performance</h2>
<p>Generally, reading feeds to memory is the fastest operation of all discussed on this page, but it is also the most RAM-consuming. Non-semantic database import is the second fastest operation, taking 2-3 times longer than to-memory reading, but it is somewhat sensible in terms of RAM consumption. Semantic feed parsing into the database is the longest of the three, taking clearly inadequate time. Unless your target machine is <em>blazingly</em> fast, or you need a reference-compliant database with correct typing, you are advised against using this.</p>
<p>The following listing provides output from the CGTFS <code>./bench</code> executable, ran on several GTFS feeds on a Win10 i7-8550U NVMe machine through WSL 1.</p>
<div class="fragment"><div class="line"># Pocono Pony (1.65 mb)</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; memory parsing:</div><div class="line"> -&gt; 1        iteration:    235690500 ns. / 1 iter. =&gt; 235.690500 ms.</div><div class="line"> -&gt; 10       iterations:   1522158000 ns. / 10 iter. =&gt; 152.215800 ms.</div><div class="line">---------</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; db parsing (semantic):</div><div class="line"> -&gt; 1        iteration:    3559970000 ns. / 1 iter. =&gt; 3559.970000 ms.</div><div class="line"> -&gt; 10       iterations:   33531279900 ns. / 10 iter. =&gt; 3353.127990 ms.</div><div class="line">---------</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; db parsing (non-semantic):</div><div class="line"> -&gt; 1        iteration:    468014300 ns. / 1 iter. =&gt; 468.014300 ms.</div><div class="line"> -&gt; 10       iterations:   5315382000 ns. / 10 iter. =&gt; 531.538200 ms.</div><div class="line">---------</div><div class="line"></div><div class="line"></div><div class="line"># LSL (20.6 mb)</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; memory parsing:</div><div class="line"> -&gt; 1        iteration:    2053141000 ns. / 1 iter. =&gt; 2053.141000 ms.</div><div class="line"> -&gt; 10       iterations:   19250407600 ns. / 10 iter. =&gt; 1925.040760 ms.</div><div class="line">---------</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; db parsing (semantic):</div><div class="line"> -&gt; 1        iteration:    14864547700 ns. / 1 iter. =&gt; 14864.547700 ms.</div><div class="line"> -&gt; 10       iterations:   151779149800 ns. / 10 iter. =&gt; 15177.914980 ms.</div><div class="line">---------</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; db parsing (non-semantic):</div><div class="line"> -&gt; 1        iteration:    3478527500 ns. / 1 iter. =&gt; 3478.527500 ms.</div><div class="line"> -&gt; 10       iterations:   34999966400 ns. / 10 iter. =&gt; 3499.996640 ms.</div><div class="line">---------</div><div class="line"></div><div class="line"></div><div class="line"># MTA NYC Transit Subway (63.4 mb)</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; memory parsing:</div><div class="line"> -&gt; 1        iteration:    5560275600 ns. / 1 iter. =&gt; 5560.275600 ms.</div><div class="line"> -&gt; 10       iterations:   53092411900 ns. / 10 iter. =&gt; 5309.241190 ms.</div><div class="line">---------</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; db parsing (semantic):</div><div class="line"> -&gt; 1        iteration:    40642734000 ns. / 1 iter. =&gt; 40642.734000 ms.</div><div class="line"> -&gt; 10       iterations:   376395287900 ns. / 10 iter. =&gt; 37639.528790 ms.</div><div class="line">---------</div><div class="line"></div><div class="line">Benchmark results for / feed dir -&gt; db parsing (non-semantic):</div><div class="line"> -&gt; 1        iteration:    9276035200 ns. / 1 iter. =&gt; 9276.035200 ms.</div><div class="line"> -&gt; 10       iterations:   91401069000 ns. / 10 iter. =&gt; 9140.106900 ms.</div><div class="line">---------</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
<address class="footer">
  <small class="desc">
    cgtfs 0.5.0 &mdash; documentation generated by <span title="on Wed Aug 14 2019 22:07:12">Doxygen 1.8.13</span>
  </small>
  <small class="links">
    <a target="_blank" href="https://rakhack.github.io/cgtfs/" title="A pretty empty website \_(*^*)_/">Website</a>&mdash;
    <a target="_blank" href="https://github.com/rakhack/cgtfs" title="Main development platform & source code repository">GitHub</a>&mdash;
    <a target="_blank" href="https://raw.githubusercontent.com/rakhack/cgtfs/master/LICENSE" title="Library code">MIT License</a>&mdash;
    <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/" title="Documentation and related materials">CC BY 4.0</a>
  </small>
</address>
</body>
</html>
